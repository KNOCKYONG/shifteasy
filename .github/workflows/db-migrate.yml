name: DB Migrate (Drizzle → Supabase)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  migrate:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Drizzle push (direct)
        env:
          # Provide the direct Postgres URL via repo secret
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
          # Prefer IPv4 to avoid IPv6-only resolution issues
          NODE_OPTIONS: --dns-result-order=ipv4first
          # Force drizzle to use DIRECT_URL
          DRIZZLE_USE_DIRECT: '1'
          # Make logs verbose and strict
          # (drizzle.config.ts already enables verbose/strict, but leaving here for clarity)
        run: |
          if [ -z "$DIRECT_URL" ]; then
            echo "DIRECT_URL secret is not set. Add it in repo Settings → Secrets and variables → Actions." >&2
            exit 1
          fi
          npx drizzle-kit push

